<!-- ResilientFlow BPEL Process [Generated by the BPEL Designer]  -->
<process name="ResilientFlow" targetNamespace="http://samples.otn.com"
         suppressJoinFailure="yes"
         xmlns="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:tns="http://samples.otn.com"
         xmlns:ns1="http://xmlns.oracle.com/pcbpel/adapter/jms/JMSService/"
         xmlns:bpelx="http://schemas.oracle.com/bpel/extension"
         xmlns:task="http://services.oracle.com/bpel/task"
         xmlns:jms="http://services.oracle.com/bpel/jms"
         xmlns:services="http://services.otn.com">
 <!-- ================================================================= -->
 <!-- PARTNERLINKS                                                      -->
 <!-- List of services participating in this BPEL process               -->
 <!-- ================================================================= -->
 <partnerLinks>
  <!--
        The 'client' role represents the requester of this service. It is
        used for callback. The location and correlation information associated
        with the client role are automatically set using WS-Addressing.
        -->
  <partnerLink name="client" partnerLinkType="tns:ResilientFlow"
               myRole="ResilientFlowProvider"
               partnerRole="ResilientFlowRequester"/>
  <partnerLink name="RatingService" partnerLinkType="services:RatingService"
               partnerRole="RatingServiceProvider"/>
  <partnerLink name="FlakyService" partnerLinkType="services:FlakyService"
               partnerRole="FlakyServiceProvider"/>
  <partnerLink name="ExceptionManagementManager"
               partnerLinkType="task:TaskManager" partnerRole="TaskManager"
               myRole="TaskManagerRequester"/>
  <partnerLink name="JMSService" partnerRole="send_role"
               partnerLinkType="ns1:send_plt"/>
 </partnerLinks>
 <!-- ================================================================= -->
 <!-- VARIABLES                                                         -->
 <!-- List of messages and XML documents used within this BPEL process  -->
 <!-- ================================================================= -->
 <variables>
  <!-- Reference to the message passed as input during initiation -->
  <!-- Reference to the message that will be sent back to the
             requester during callback
             -->
  <variable name="input" messageType="tns:ResilientFlowRequestMessage"/>
  <variable name="output" messageType="tns:ResilientFlowResponseMessage"/>
  <variable messageType="services:getRatingRequest" name="ratingRequest"/>
  <variable messageType="services:getRatingResponse" name="ratingResponse"/>
  <variable messageType="services:getAccountIdRequest" name="flakyRequest"/>
  <variable messageType="services:getAccountIdResponse" name="flakyResponse"/>
  <variable messageType="bpelx:RuntimeFaultMessage" name="runtimeException"/>
  <variable name="jmsRequest" messageType="ns1:send_msg"/>
 </variables>
 <!-- ================================================================= -->
 <!-- ORCHESTRATION LOGIC                                               -->
 <!-- Set of activities coordinating the flow of messages across the    -->
 <!-- services integrated within this business process                  -->
 <!-- ================================================================= -->
 <faultHandlers>
  <!-- Runtime fault message handling -->
  <catch faultVariable="runtimeException" faultName="bpelx:remoteFault">
   <sequence>
    <assign>
     <!-- copy literal jms message -->
     <copy>
      <from>
       <jmsMessage xmlns="http://services.oracle.com/bpel/jms">
        <destination>
         <connectorName>ExceptionJMSBus</connectorName>
         <destinationId>ExceptionQueueId</destinationId>
        </destination>
        <contentType>text</contentType>
        <content/>
       </jmsMessage>
      </from>
      <to variable="jmsRequest" part="opaque"/>
     </copy>
     <!-- copy the request for quote (RFQ) info to the jms message content -->
     <!--copy>
      <from expression="concat('Exception for ssn ',bpws:getVariableData( 'input','payload','/tns:ssn' ))"/>
      <to variable="jmsRequest" part="opaque"
          query="/jms:jmsMessage/jms:content"/>
     </copy-->
    </assign>
    <!-- invoke the jms service which will send the RFQ jms message to SellerQueueId -->
    <invoke name="sendJMS" partnerLink="JMSService" portType="ns1:send_ptt"
            operation="send" inputVariable="jmsRequest"/>
   </sequence>
  </catch>
  <catch faultVariable="runtimeException" faultName="bpelx:bindingFault">
   <terminate/>
  </catch>
 </faultHandlers>
 <sequence name="main">
  <!-- Receive input from requestor.
             Note: This maps to operation defined in ResilientFlow.wsdl
             -->
  <receive name="receiveInput" partnerLink="client" portType="tns:ResilientFlow"
           operation="initiate" variable="input" createInstance="yes"/>
  <!-- Asynchronous callback to the requester.
             Note: the callback location and correlation id is transparently handled
             using WS-addressing.
             -->
  <assign>
   <copy>
    <from variable="input" part="payload" query="/tns:ssn"/>
    <to variable="ratingRequest" part="ssn"/>
   </copy>
  </assign>
  <invoke name="invokeRatingService" partnerLink="RatingService"
          portType="services:RatingService" operation="getRating"
          inputVariable="ratingRequest" outputVariable="ratingResponse"/>
  <scope>
   <faultHandlers>
    <catchAll>
     <scope name="ExceptionManagement" variableAccessSerializable="no">
      <variables>
       <variable name="ExceptionManagementTask" element="task:task"/>
      </variables>
      <sequence>
       <assign name="configureTask">
        <!-- Assign 'title' in task document -->
        <copy>
         <from expression="string( 'ExceptionManagement' )"/>
         <to variable="ExceptionManagementTask" query="/task:task/task:title"/>
        </copy>
        <!-- Assign 'creator' in task document -->
        <copy>
         <from expression="string( 'ResilientFlow' )"/>
         <to variable="ExceptionManagementTask"
             query="/task:task/task:creator"/>
        </copy>
        <!-- Assign 'assignee' in task document -->
        <copy>
         <from expression="string( 'assignee@acm.org' )"/>
         <to variable="ExceptionManagementTask"
             query="/task:task/task:assignee"/>
        </copy>
        <!-- Assign 'duration' in task document -->
        <copy>
         <from expression="string( 'PT1H' )"/>
         <to variable="ExceptionManagementTask"
             query="/task:task/task:duration"/>
        </copy>
        <!-- Assign 'priority' in task document -->
        <copy>
         <from expression="3"/>
         <to variable="ExceptionManagementTask"
             query="/task:task/task:priority"/>
        </copy>
        <!-- Assign 'attachment' in task document -->
        <copy>
         <from variable="input" part="payload" query="/tns:ssn"/>
         <to variable="ExceptionManagementTask"
             query="/task:task/task:attachment"/>
        </copy>
       </assign>
       <scope name="ExceptionManagementUserInteraction"
              variableAccessSerializable="no">
        <variables>
         <variable name="taskRequest" messageType="task:taskMessage"/>
         <variable name="taskResponse" messageType="task:taskMessage"/>
        </variables>
        <sequence>
         <!-- Assign task document to taskMessage -->
         <assign name="setPayload">
          <copy>
           <from variable="ExceptionManagementTask"/>
           <to variable="taskRequest" part="payload"/>
          </copy>
         </assign>
         <!--  initiate task -->
         <invoke name="initiateTask" partnerLink="ExceptionManagementManager"
                 portType="task:TaskManager" operation="initiateTask"
                 inputVariable="taskRequest"/>
         <!--  Receive the outcome of the task -->
         <receive name="receiveTaskResult"
                  partnerLink="ExceptionManagementManager"
                  portType="task:TaskManagerCallback" operation="onTaskResult"
                  variable="taskResponse" createInstance="no"/>
         <!-- Read task document from taskMessage -->
         <assign name="readPayload">
          <copy>
           <from variable="taskResponse" part="payload"/>
           <to variable="ExceptionManagementTask"/>
          </copy>
         </assign>
        </sequence>
       </scope>
       <assign name="setflakyResponse">
        <copy>
         <from variable="ExceptionManagementTask"
               query="/task:task/task:attachment"/>
         <to variable="flakyResponse" part="getAccountIdReturn"/>
        </copy>
       </assign>
      </sequence>
     </scope>
    </catchAll>
   </faultHandlers>
   <sequence>
    <assign>
     <copy>
      <from variable="input" part="payload" query="/tns:ssn"/>
      <to variable="flakyRequest" part="ssn"/>
     </copy>
    </assign>
    <invoke name="invokeFlakyService" partnerLink="FlakyService"
            portType="services:FlakyService" operation="getAccountId"
            inputVariable="flakyRequest" outputVariable="flakyResponse"/>
   </sequence>
  </scope>
  <invoke name="callbackClient" partnerLink="client"
          portType="tns:ResilientFlowCallback" operation="onResult"
          inputVariable="output"/>
 </sequence>
</process>
