<!-- WorkoutProcess BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Tue Apr 26 18:13:41 EDT 2011 -->
<process name="WorkoutProcess"
         targetNamespace="http://www.ipfw.edu/services/workout"
         suppressJoinFailure="yes"
         xmlns:wsd="http://schemas.xmlsoap.org/wsdl/"
         xmlns:tns="http://www.ipfw.edu/services/workout"
         xmlns:secp="http://ipfw.edu/services/securepatron/"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:pat="http://ipfw.edu/services/patron/"
         xmlns:eq="http://ipfw.edu/services/equipment"
         xmlns:sece="http://ipfw.edu/services/secureequipment"
         xmlns:trn="http://ipfw.edu/services/training/"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable">

    <!-- Import the client WSDL -->
	<import location="WorkoutProcessArtifacts.wsdl" namespace="http://www.ipfw.edu/services/workout" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	       <wsd:import namespace="http://ipfw.edu/services/patron/" location="PatronService.wsdl"/>
	   <wsd:import namespace="http://ipfw.edu/services/securepatron/" location="SecurePatronService.wsdl"/>
	   <wsd:import namespace="http://ipfw.edu/services/equipment" location="EquipmentService.wsdl"/>
	   <wsd:import namespace="http://ipfw.edu/services/secureequipment" location="SecureEquipmentService.wsdl"/>
	   <wsd:import namespace="http://ipfw.edu/services/training/" location="TrainingService.wsdl"/> 
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <partnerLink name="Workout"
                     partnerLinkType="tns:WorkoutProcess"
                     myRole="WorkoutProcessProvider"
                     />
        <partnerLink name="Patron"
                     partnerLinkType="tns:PatronService"
                     partnerRole="PatronServiceProvider"
                     />
        <partnerLink name="SecurePatron"
                     partnerLinkType="tns:SecurePatronService"
                     partnerRole="SecurePatronServiceProvider"
                     />
        <partnerLink name="Equipment"
                     partnerLinkType="tns:EquipmentService"
                     partnerRole="EquipmentServiceProvider"
                     />
        <partnerLink name="SecureEquipment"
                     partnerLinkType="tns:SecureEquipmentService"
                     partnerRole="SecureEquipmentServiceProvider"
                     />
        <partnerLink name="Training"
                     partnerLinkType="tns:TrainingService"
                     partnerRole="TrainingServiceProvider"
                     />
        
    </partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->   
    
    <variables>
    	<variable name="beginWorkout" messageType="trn:createPatronWorkoutRequest"/>
    	<variable name="checkInRequest" messageType="secp:checkInRequest" />
    	<variable name="checkInResponse" messageType="secp:checkInResponse" />
    	
    	<variable name="createPatronWorkoutResponse" messageType="trn:createPatronWorkoutResponse" />
    	<variable name="workoutInProgress" type="xsd:boolean" />
    	<variable name="endWorkoutRequest" messageType="tns:endWorkoutRequest"/>
    	<variable name="addVisitRequest" messageType="secp:addVisitRequest" />
    	<variable name="addVisitResponse" messageType="secp:addVisitResponse" />
    	<variable name="checkOutRequest" messageType="secp:checkOutRequest" />
    	<variable name="checkOutResponse" messageType="secp:checkOutResponse" />
    	<variable name="beginExerciseRequest" messageType="trn:beginEquipmentWorkoutRequest"/>
    	<variable name="exerciseInProgress" type="xsd:boolean" />
    	<variable name="endExerciseRequest" messageType="trn:endEquipmentWorkoutRequest"/>
    	<variable name="endEquipmentWorkoutResponse" messageType="trn:endEquipmentWorkoutResponse"/>
    	<variable name="updateEquipmentWorkoutResponse" messageType="trn:updateEquipmentWorkoutResponse" />
    	<variable name="beginEquipmentWorkoutResponse" messageType="trn:beginEquipmentWorkoutResponse" />
    	<variable name="recordExerciseDetailsRequest" messageType="trn:updateEquipmentWorkoutRequest"/>
    	<variable name="startTime" type="xsd:dateTime" />
    	
    	

    </variables>      

	<!-- ================================================================= -->         
    <!-- CORRELATION SETS                                                  -->
    <!-- Define identifiers and mappings between various services          -->
    <!-- ================================================================= -->   

<!-- 	<correlationSets> -->
<!-- 		<correlationSet name="checkInInteraction" properties="tns:patronId" /> -->
<!-- 	</correlationSets> -->
	
    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    
    <sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in WorkoutProcess.wsdl 
             -->
        
        
        <!-- Generate reply to synchronous request -->
        
        <receive name="ReceiveBeginWorkout" partnerLink="Workout" operation="beginWorkout" createInstance="yes" variable="beginWorkout"></receive>
        <assign>
        	<copy>
        		<from variable="beginWorkout" part="p10">
                    <query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        /patronId
                    </query>
                </from>
        		<to variable="checkInRequest" part="p12">
                    <query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    	/id
                    </query>
                </to>
        	</copy>
        	<copy>
        		<from variable="beginWorkout" part="p10">
                    <query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        /dateTime
                    </query>     		
        		</from>
        		<to variable="addVisitRequest" part="p22">
                    <query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        /startDateTime
                    </query>
        		</to>
        	</copy>
        </assign>
        <invoke name="InvokeCheckIn" partnerLink="SecurePatron" operation="checkIn" inputVariable="checkInRequest" outputVariable="checkInResponse">
<!--             <correlations> -->
<!--                 <correlation set="checkInInteraction" initiate="no" pattern="response"></correlation> -->
                
<!--             </correlations> -->
        </invoke>

       
        <invoke name="InvokeCreatePatronWorkout" partnerLink="Training" operation="createPatronWorkout" inputVariable="beginWorkout" outputVariable="createPatronWorkoutResponse"></invoke>
        <assign>
        	<copy>
        		<from >
                    true()
                </from>
        		<to variable="workoutInProgress" />
        	</copy>
        </assign>
        <while name="WhileWorkoutInProgress" >
                   

            <condition>
                'workoutInProgress'=true()
            </condition>
            <pick name="Pick">
                <onMessage partnerLink="Workout" operation="endWorkout" variable="endWorkoutRequest">
                 <assign>
        			<copy>
        				<from variable="endWorkoutRequest" part="p0">
                    		<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        		/patronId
                    		</query>
                		</from>
        				<to variable="checkOutRequest" part="p14">
                    		<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    			/id
                    		</query>
                		</to>
        			</copy>
        			<copy>
        				<from variable="endWorkoutRequest" part="p0">
                    		<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        		/patronId
                    		</query>
                		</from>
        				<to variable="addVisitRequest" part="p22">
                    		<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    			/id
                    		</query>
                		</to>
        			</copy>
        			<copy>
        				<from variable="endWorkoutRequest" part="p0">
                    		<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        		/endDateTime
                    		</query>
                		</from>
        				<to variable="addVisitRequest" part="p22">
                    		<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    			/endDateTime
                    		</query>
                		</to>
        			</copy>
        			
        			
       				 </assign>
                    <sequence>
                        <invoke name="InvokeAddVisit" partnerLink="SecurePatron" operation="addVisit" inputVariable="addVisitRequest" outputVariable="addVisitResponse"></invoke>
                        <invoke name="InvokeCheckOut" partnerLink="SecurePatron" operation="checkOut" inputVariable="checkOutRequest" outputVariable="checkOutResponse"></invoke>
                        <assign validate="no" name="AssignFalseToWorkoutInProgess">
                            <copy>
                                <from>
                                    false()
                                </from>
                                <to variable="workoutInProgress"></to>
                            </copy>
                        </assign>
                    </sequence>
                </onMessage>
                <onMessage partnerLink="Workout" operation="beginExercise" variable="beginExerciseRequest">
                    <sequence>
                    	<invoke name="InvokeBeginEquipmentWorkout" partnerLink="Training" operation="beginEquipmentWorkout" inputVariable="beginExerciseRequest" outputVariable="beginEquipmentWorkoutResponse"/>
                        <assign validate="no" name="AssignTrueToExerciseInProgress">
                        	<copy>
                                <from>
                                    true()
                                </from>
                                <to variable="exerciseInProgress"></to>
                       		</copy>
                  
                        </assign>
                        <while name="WhileExerciseInProgress">
                        	            <condition>
                							'exerciseInProgress'=true()
            							</condition>
                            <pick name="Pick1">
                            	<onMessage partnerLink="Workout" operation="endExercise" variable="endExerciseRequest">
                                    <sequence>
                                        <invoke name="InvokeEndEquipmentWorkout" partnerLink="Training" operation="endEquipmentWorkout" inputVariable="endExerciseRequest" outputVariable="endEquipmentWorkoutResponse"></invoke>
                                        <assign validate="no" name="AssignFalseToExerciseInProgress">
                                        <copy>
                               				 <from>
                                  			  false()
                                			</from>
                               				 <to variable="exerciseInProgress"></to>
                          				  </copy>
                                        </assign>
                                    </sequence>
                                </onMessage>
                                <onMessage partnerLink="Workout" operation="recordExerciseDetails" variable="recordExerciseDetailsRequest" >
                                    <invoke name="InvokeUpdateEquipmentWorkout" partnerLink="Training" operation="updateEquipmentWorkout" inputVariable="recordExerciseDetailsRequest" outputVariable="updateEquipmentWorkoutResponse"></invoke>
                                </onMessage>
                            </pick>
                        </while>
                    </sequence>
                </onMessage>
            </pick>
        </while>
    </sequence>
</process>

